<!DOCTYPE html>
<html lang="ar">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>السحب</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header>
    <div class="container">
      <div class="header-top">
        <a href="index.html" class="logo">
          <i class="fas fa-cogs"></i>
          صندوق | box
        </a>
        <div class="header-actions">
          <button onclick="logout()" title="تسجيل الخروج"><i class="fas fa-sign-out-alt"></i></button>
        </div>
      </div>
      <nav>
        <a href="index.html">
          <i class="fas fa-home"></i>
          <span>الرئيسية</span>
        </a>
        <a href="members.html">
          <i class="fas fa-users"></i>
          <span>الأعضاء</span>
        </a>
        <a href="deposit.html">
          <i class="fas fa-wallet"></i>
          <span>إيداع</span>
        </a>
        <a href="withdraw.html" class="active">
          <i class="fas fa-university"></i>
          <span>سحب</span>
        </a>
        <a href="reports.html">
          <i class="fas fa-chart-bar"></i>
          <span>تقارير</span>
        </a>
        <a href="users.html">
          <i class="fas fa-user-cog"></i>
          <span>المستخدمين</span>
        </a>
        <a href="settings.html">
          <i class="fas fa-cog"></i>
          <span>الإعدادات</span>
        </a>
      </nav>
    </div>
  </header>
  <main>
    <div class="container">

      <section>
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-list"></i> آخر السحوبات</div>
            <button class="btn primary sm" onclick="openWithdrawModal()"><i class="fas fa-plus"></i> سحب جديد</button>
          </div>
          <div id="withdrawals-table-container"></div>
        </div>
      </section>

      <!-- نافذة السحب المنبثقة -->
      <div id="withdraw-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="modal-title" class="modal-title">إضافة سحب جديد</h3>
            <button class="modal-close" onclick="closeWithdrawModal()">&times;</button>
          </div>
          <div class="modal-body">
            <form id="withdraw-form">
              <input type="hidden" id="withdraw-id">
              <div class="form-group">
                <select id="withdraw-fund" required>
                  <option value="">اختر الصندوق</option>
                </select>
              </div>
              <div class="form-group">
                <input type="number" id="withdraw-amount" placeholder="أدخل المبلغ" step="0.01" required inputmode="numeric">
              </div>
              <div class="form-group">
                <input type="text" id="withdraw-recipient" placeholder="المستلم" required>
              </div>
              <div class="form-group">
                <textarea id="withdraw-notes" placeholder="ملاحظات" rows="2"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn" onclick="closeWithdrawModal()">إلغاء</button>
            <button type="submit" form="withdraw-form" class="btn primary">حفظ السحب</button>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3 id="confirmationModalTitle" class="modal-title">تأكيد الإجراء</h3>
        <button class="modal-close" onclick="closeConfirmationModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirmationModalText">هل أنت متأكد من رغبتك في المتابعة؟</p>
      </div>
      <div class="modal-footer">
        <button id="cancelBtn" class="btn" onclick="closeConfirmationModal()">إلغاء</button>
        <button id="confirmBtn" class="btn primary" onclick="handleConfirm()">تأكيد</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="container">
      <p>&copy; 2024 Studio10 للأنظمة الإدارية. جميع الحقوق محفوظة.</p>
    </div>
  </footer>

  <script src="script.js"></script>
  <script>
    // ==========================================================
    // إدارة نافذة السحب (Modal)
    // ==========================================================
    const withdrawModal = document.getElementById('withdraw-modal');
    const withdrawForm = document.getElementById('withdraw-form');
    const modalTitle = document.getElementById('modal-title');

    function openWithdrawModal(withdrawId = null) {
      withdrawForm.reset();
      document.getElementById('withdraw-id').value = '';

      if (withdrawId) {
        modalTitle.textContent = 'تحرير السحب';
        const withdrawals = getFromStorage('withdrawals', []);
        const withdrawal = withdrawals.find(w => w.id === withdrawId);
        if (withdrawal) {
          // تعبئة بيانات النموذج
          document.getElementById('withdraw-id').value = withdrawal.id;
          document.getElementById('withdraw-fund').value = withdrawal.fundId;
          document.getElementById('withdraw-amount').value = withdrawal.amount;
          document.getElementById('withdraw-recipient').value = withdrawal.recipient;
          document.getElementById('withdraw-notes').value = withdrawal.notes;
        }
      } else {
        modalTitle.textContent = 'إضافة سحب جديد';
      }
      withdrawModal.classList.add('show');
    }

    function closeWithdrawModal() {
      withdrawModal.classList.remove('show');
    }

    // ==========================================================
    // معالجة نموذج السحب
    // ==========================================================
    document.getElementById('withdraw-form').addEventListener('submit', function (e) {
      e.preventDefault();
      const withdrawId = document.getElementById('withdraw-id').value;
      const fundId = parseInt(document.getElementById('withdraw-fund').value);
      const amount = document.getElementById('withdraw-amount').value;
      const recipient = document.getElementById('withdraw-recipient').value;
      const notes = document.getElementById('withdraw-notes').value || '';

      if (!fundId || !amount || !recipient) {
        showAlert('يرجى تعبئة جميع الحقول المطلوبة.', 'error');
        return;
      }

      const withdrawalData = { fundId, amount, recipient, notes };

      if (withdrawId) {
        updateWithdrawal(parseInt(withdrawId), withdrawalData);
      } else {
        addWithdrawal(withdrawalData);
      }

      closeWithdrawModal();
      renderWithdrawalsTable('withdrawals-table-container');
    });

    // ==========================================================
    // دوال إدارة بيانات السحوبات
    // ==========================================================
    function addWithdrawal(data) {
      const withdrawals = getFromStorage('withdrawals', []);
      const newWithdrawal = {
        id: Date.now(),
        fundId: data.fundId,
        amount: parseFloat(data.amount),
        recipient: data.recipient,
        notes: data.notes,
        date: new Date().toLocaleDateString('en-CA'), // ⭐️ تم التعديل: استخدام تنسيق ميلادي رقمي
        time: new Date().toLocaleTimeString('ar-SA')
      };
      withdrawals.push(newWithdrawal);
      saveToStorage('withdrawals', withdrawals);
      showAlert('تم تسجيل السحب بنجاح', 'success');
    }

    function updateWithdrawal(id, data) {
      const withdrawals = getFromStorage('withdrawals', []);
      const index = withdrawals.findIndex(w => w.id === id);
      if (index !== -1) {
        withdrawals[index] = { ...withdrawals[index], ...data, amount: parseFloat(data.amount) };
        saveToStorage('withdrawals', withdrawals);
        showAlert('تم تحديث السحب بنجاح', 'success');
      }
    }

    function deleteWithdrawal(id) {
      const message = 'هل أنت متأكد من حذف هذا السحب؟ لا يمكن التراجع عن هذا الإجراء.';
      showConfirmationModal(message, () => {
        let withdrawals = getFromStorage('withdrawals', []);
        withdrawals = withdrawals.filter(w => w.id !== id);
        saveToStorage('withdrawals', withdrawals);
        showAlert('تم حذف السحب.', 'info');
        renderWithdrawalsTable('withdrawals-table-container');
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      renderWithdrawalsTable('withdrawals-table-container');
      populateWithdrawDropdowns(); // ⭐️ تم إضافة استدعاء الدالة هنا
    });

    function logout() {
      const message = 'هل أنت متأكد من رغبتك في تسجيل الخروج؟';
      showConfirmationModal(message, () => {
        showAlert('تم تسجيل الخروج بنجاح', 'success');
      });
    }

    function renderWithdrawalsTable(containerId) {
      const withdrawals = getFromStorage('withdrawals', []);
      const members = getFromStorage('members', []);
      const funds = getFromStorage('boxes', []); // أو 'funds' إذا كنت تستخدم هذا الاسم
      const container = document.getElementById(containerId);

      if (!container) return;

      if (withdrawals.length === 0) {
        container.innerHTML = '<p class="text-center mt-20 text-muted">لا توجد سحوبات حالياً. ابدأ بإضافة سحب جديد.</p>';
        return;
      }

      const sorted = [...withdrawals].reverse();
      let html = `
        <table>
          <thead>
            <tr>
              <th>الصندوق</th>
              <th>المبلغ</th>
              <th>المستلم</th>
              <th>التاريخ</th>
              <th>الإجراء</th>
            </tr>
          </thead>
          <tbody>`;

      sorted.forEach(withdrawal => {
        const fund = funds.find(f => f.id === withdrawal.fundId);
        html += `
          <tr>
            <td>${fund ? fund.name : 'صندوق محذوف'}</td>
            <td>${formatNumber(withdrawal.amount)}</td>
            <td>${withdrawal.recipient}</td>
            <td>${withdrawal.date}</td>
            <td>
              <div class="flex" style="gap: 5px; justify-content: center;">
                <button class="btn icon-frameless" onclick="openWithdrawModal(${withdrawal.id})" title="تحرير"><i class="fas fa-edit" style="color: var(--text-secondary);"></i></button>
                <button class="btn icon-frameless" onclick="deleteWithdrawal(${withdrawal.id})" title="حذف"><i class="fas fa-trash-alt" style="color: var(--error-color);"></i></button>
              </div>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ==========================================================
    // دوال مساعدة لتعبئة القوائم المنسدلة
    // ==========================================================
    function populateWithdrawDropdowns() {
      const funds = getFromStorage('boxes', []);
      const fundSelect = document.getElementById('withdraw-fund');

      fundSelect.innerHTML = '<option value="">اختر الصندوق</option>';
      funds.forEach(fund => fundSelect.innerHTML += `<option value="${fund.id}">${fund.name}</option>`);
    }
  </script>
</body>

</html>